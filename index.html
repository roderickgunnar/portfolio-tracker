<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#000000" />
  <title>Portfolio Tracker</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #000000;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      -webkit-font-smoothing: antialiased;
      overflow-x: hidden;
    }
    #root { min-height: 100vh; }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
    select:focus { outline: 2px solid #6366f1; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

    /* Mobile responsive */
    @media (max-width: 768px) {
      .stat-cards { flex-direction: column !important; }
      .stat-cards > div { min-width: unset !important; }
      .charts-grid { grid-template-columns: 1fr !important; }
      .header-row { flex-direction: column !important; gap: 12px !important; align-items: flex-start !important; }
      .filter-row { flex-direction: column !important; gap: 8px !important; }
      .tab-nav { overflow-x: auto !important; flex-wrap: nowrap !important; }
      .main-wrap { padding: 16px !important; }
      .pie-inner { flex-direction: column !important; }
      .pie-inner > div:first-child { width: 100% !important; }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js');
      });
    }
  </script>

  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
  <script>window.PropTypes = window.PropTypes || window.propTypes;</script>
  <script crossorigin src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useMemo, useEffect, useCallback, useRef } = React;
    const { PieChart, Pie, Cell, BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, CartesianGrid } = Recharts;

    // ─── Finnhub API ──────────────────────────────────────────────────────────────
    const FINNHUB_KEY = "d568c8hr01qu3qo92efgd568c8hr01qu3qo92eg0";
    const fetchPrice = async (symbol) => {
      // Clean symbol: remove " (Indiv)" suffixes, skip non-stock symbols
      const clean = symbol.replace(/\s*\(.*?\)\s*$/, "");
      if (clean.startsWith("Target ") || clean === "Cash") return null;
      try {
        const res = await fetch(`https://finnhub.io/api/v1/quote?symbol=${encodeURIComponent(clean)}&token=${FINNHUB_KEY}`);
        const data = await res.json();
        if (data && data.c > 0) return { symbol: clean, price: data.c };
      } catch (e) { console.warn("Finnhub error for", clean, e); }
      return null;
    };

    const fetchAllPrices = async (symbols) => {
      const unique = [...new Set(symbols.map(s => s.replace(/\s*\(.*?\)\s*$/, "")).filter(s => !s.startsWith("Target ") && s !== "Cash"))];
      const prices = {};
      // Finnhub free tier: 60 calls/min, fetch sequentially with small delay
      for (const sym of unique) {
        const result = await fetchPrice(sym);
        if (result) prices[result.symbol] = result.price;
        await new Promise(r => setTimeout(r, 250)); // rate limit
      }
      return prices;
    };

    // ─── CSV Parsers ──────────────────────────────────────────────────────────────
    const SCHWAB_ACCOUNT_MAP = {
      "XXX210": "Schwab Individual",
      "XXX236": "Schwab Rollover IRA",
      "XXX037": "Schwab PCRA Trust",
      "XXX157": "Schwab PCRA Trust 2",
    };

    const parseCSVLine = (line) => {
      const result = [];
      let current = "";
      let inQuotes = false;
      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"') { inQuotes = !inQuotes; }
        else if (ch === ',' && !inQuotes) { result.push(current.trim()); current = ""; }
        else { current += ch; }
      }
      result.push(current.trim());
      return result;
    };

    const parseDollar = (s) => {
      if (!s) return 0;
      const clean = s.replace(/[$,]/g, "");
      return parseFloat(clean) || 0;
    };

    const categorizeSchwabAction = (action) => {
      const a = action.toLowerCase();
      if (a === "buy") return { category: "BUY", action: "Buy" };
      if (a === "sell") return { category: "SELL", action: "Sell" };
      if (a === "sell to open") return { category: "OPTIONS", action: "Sell to Open" };
      if (a === "buy to close") return { category: "OPTIONS", action: "Buy to Close" };
      if (a === "sell to close") return { category: "OPTIONS", action: "Sell to Close" };
      if (a === "buy to open") return { category: "OPTIONS", action: "Buy to Open" };
      if (a === "assigned" || a === "expired") return { category: "OPTIONS", action };
      if (a.includes("dividend") || a.includes("div")) return { category: "DIVIDEND", action: "Dividend" };
      if (a.includes("transfer") || a.includes("journal")) return { category: "CASH_MGMT", action: "Transfer" };
      if (a.includes("contribution")) return { category: "CONTRIBUTION", action: "Contribution" };
      return { category: "OTHER", action };
    };

    const parseSchwabCSV = (text, filename) => {
      // Detect account from filename pattern: _XXX###_
      let accountName = "Unknown Schwab";
      const m = filename.match(/_(XXX\d+)_/);
      if (m && SCHWAB_ACCOUNT_MAP[m[1]]) accountName = SCHWAB_ACCOUNT_MAP[m[1]];

      const lines = text.split("\n").filter(l => l.trim());
      if (lines.length < 2) return [];

      // Skip header (first line with "Date","Action",...)
      const transactions = [];
      for (let i = 1; i < lines.length; i++) {
        const cols = parseCSVLine(lines[i]);
        if (cols.length < 8) continue;
        const [dateRaw, actionRaw, symbol, , , , , amountRaw] = cols;
        if (!dateRaw || dateRaw.startsWith("Transactions Total")) continue;

        // Parse date: "MM/DD/YYYY" or "MM/DD/YYYY as of MM/DD/YYYY"
        const datePart = dateRaw.split(" as of ")[0].trim();
        const [mm, dd, yyyy] = datePart.split("/");
        if (!mm || !dd || !yyyy) continue;
        const isoDate = `${yyyy}-${mm.padStart(2, "0")}-${dd.padStart(2, "0")}`;

        const { category, action } = categorizeSchwabAction(actionRaw);
        const amount = parseDollar(amountRaw);

        // Clean symbol for display
        const cleanSymbol = symbol || "Cash";

        transactions.push({ date: isoDate, account: accountName, category, action, symbol: cleanSymbol, amount });
      }
      return transactions;
    };

    const parseVanguardCSV = (text) => {
      const lines = text.split("\n");
      const transactions = [];
      let inTransactionSection = false;
      let txHeaderFound = false;

      // Vanguard account numbers to names
      const vanguardAcctMap = {
        "67797015": "Vanguard Brokerage",
        "88487389": "Vanguard Cash",
        "54832192": "Vanguard Cash 2",
        "48778142": "Vanguard Cash 3",
      };

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;

        // Detect transaction section header
        if (line.startsWith("Account Number,Trade Date,Settlement Date")) {
          inTransactionSection = true;
          txHeaderFound = true;
          continue;
        }

        if (!inTransactionSection) continue;

        const cols = parseCSVLine(line);
        if (cols.length < 14) continue;

        const [acctNum, tradeDate, , txType, , , symbol, , , amount, , , ,] = cols;
        if (!tradeDate || tradeDate === "Trade Date") continue;

        const accountName = vanguardAcctMap[acctNum] || `Vanguard ${acctNum}`;
        const isoDate = tradeDate; // already YYYY-MM-DD format
        const amountVal = parseFloat(amount) || 0;

        let category = "OTHER", action = txType;
        const tt = txType.toLowerCase();
        if (tt === "buy") { category = "BUY"; action = "Buy"; }
        else if (tt === "sell") { category = "SELL"; action = "Sell"; }
        else if (tt.includes("dividend")) { category = "DIVIDEND"; action = "Dividend"; }
        else if (tt.includes("contribution")) { category = "CONTRIBUTION"; action = "Contribution"; }
        else if (tt.includes("sweep") || tt.includes("transfer")) { category = "CASH_MGMT"; action = "Transfer"; }
        else if (tt === "reinvestment") { category = "DIVIDEND"; action = "Reinvestment"; }

        transactions.push({ date: isoDate, account: accountName, category, action, symbol: symbol || "Cash", amount: amountVal });
      }
      return transactions;
    };

    const detectAndParseCSV = (text, filename) => {
      const lower = filename.toLowerCase();
      if (lower.includes("vanguard")) return parseVanguardCSV(text);
      // Default to Schwab format (has XXX pattern or "Date","Action" header)
      return parseSchwabCSV(text, filename);
    };

    // ─── localStorage helpers ─────────────────────────────────────────────────────
    const STORAGE_KEY = "portfolio_uploaded_transactions";
    const loadUploadedTransactions = () => {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); } catch { return []; }
    };
    const saveUploadedTransactions = (txs) => {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(txs));
    };

    // Simple SVG icon components (replacing lucide-react)
    const Icon = ({ d, size = 24, color = "currentColor" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d={d} />
      </svg>
    );
    const TrendingUp = ({ size, color }) => <Icon size={size} color={color} d="M22 7l-8.5 8.5-5-5L2 17 M16 7h6v6" />;
    const TrendingDown = ({ size, color }) => <Icon size={size} color={color} d="M22 17l-8.5-8.5-5 5L2 7 M16 17h6v-6" />;
    const DollarSign = ({ size, color }) => <Icon size={size} color={color} d="M12 1v22 M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6" />;
    const BarChart3 = ({ size, color }) => <Icon size={size} color={color} d="M3 3v18h18 M7 16v-3 M12 16v-8 M17 16v-5" />;
    const Activity = ({ size, color }) => <Icon size={size} color={color} d="M22 12h-4l-3 9L9 3l-3 9H2" />;
    const ChevronDown = ({ size, style }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={style}><path d="M6 9l6 6 6-6"/></svg>;
    const ArrowUpRight = ({ size }) => <Icon size={size} d="M7 17L17 7 M7 7h10v10" />;
    const ArrowDownRight = ({ size }) => <Icon size={size} d="M7 7l10 10 M17 7v10H7" />;

    // ─── Raw Data ────────────────────────────────────────────────────────────────

    const ACCOUNTS = {
      "All Accounts": {
        totalValue: 184815.78, costBasis: 210332.14, unrealizedGL: -25516.36, unrealizedPct: -0.1213,
        realizedSTGL: 21596.34, realizedLTGL: 0, totalRealizedGL: 21596.34, totalDividends: 116.30,
        netOptionsPremium: 4069.86, totalReturn: 266.13,
      },
      "Vanguard 401K": {
        totalValue: 7486.71, costBasis: 40378.09, unrealizedGL: -32891.38, unrealizedPct: -0.8146,
        realizedSTGL: 0, realizedLTGL: 0, totalRealizedGL: 0, totalDividends: 0,
        netOptionsPremium: 0, totalReturn: -32891.38,
      },
      "Vanguard Brokerage": {
        totalValue: 18676.21, costBasis: 17580.99, unrealizedGL: 1095.21, unrealizedPct: 0.0623,
        realizedSTGL: 2164.14, realizedLTGL: 0, totalRealizedGL: 2164.14, totalDividends: 68.56,
        netOptionsPremium: 0, totalReturn: 3327.91,
      },
      "Schwab PCRA Trust": {
        totalValue: 25961.25, costBasis: 26572.89, unrealizedGL: -611.64, unrealizedPct: -0.023,
        realizedSTGL: -812.32, realizedLTGL: 0, totalRealizedGL: -812.32, totalDividends: 16.78,
        netOptionsPremium: 0, totalReturn: -1407.18,
      },
      "Schwab PCRA Trust 2": {
        totalValue: 7261.80, costBasis: 7474.00, unrealizedGL: -212.20, unrealizedPct: -0.0284,
        realizedSTGL: 0, realizedLTGL: 0, totalRealizedGL: 0, totalDividends: 0,
        netOptionsPremium: 0, totalReturn: -212.20,
      },
      "Schwab Individual": {
        totalValue: 26458.96, costBasis: 21883.88, unrealizedGL: 4575.09, unrealizedPct: 0.2091,
        realizedSTGL: 2395.27, realizedLTGL: 0, totalRealizedGL: 2395.27, totalDividends: 1.33,
        netOptionsPremium: 715.68, totalReturn: 7687.37,
      },
      "Schwab Rollover IRA": {
        totalValue: 98970.85, costBasis: 96442.29, unrealizedGL: 2528.56, unrealizedPct: 0.0262,
        realizedSTGL: 17849.25, realizedLTGL: 0, totalRealizedGL: 17849.25, totalDividends: 29.63,
        netOptionsPremium: 3354.18, totalReturn: 23761.62,
      },
    };

    const HOLDINGS_BY_ACCOUNT = {
      "All Accounts": [
        { symbol: "GOOGL", shares: 183.017, avgCost: 321.91, price: 311.78, marketValue: 57061.04, costBasis: 58915.10, unrealizedGL: -1854.06, unrealizedPct: -0.0315, realizedGL: 1584.45, dividends: 16.80 },
        { symbol: "BE", shares: 215, avgCost: 157.20, price: 154.25, marketValue: 33163.75, costBasis: 33797.00, unrealizedGL: -633.25, unrealizedPct: -0.0187, realizedGL: 4048.92, dividends: 0 },
        { symbol: "GOOG", shares: 106, avgCost: 244.29, price: 312.39, marketValue: 33113.34, costBasis: 25895.24, unrealizedGL: 7218.10, unrealizedPct: 0.2787, realizedGL: 0, dividends: 22.26 },
        { symbol: "PLTR", shares: 107, avgCost: 99.40, price: 134.89, marketValue: 14433.05, costBasis: 10635.45, unrealizedGL: 3797.60, unrealizedPct: 0.3571, realizedGL: 585.42, dividends: 0 },
        { symbol: "NVDA", shares: 48.00, avgCost: 177.09, price: 190.40, marketValue: 9139.87, costBasis: 8501.05, unrealizedGL: 638.82, unrealizedPct: 0.0751, realizedGL: 774.15, dividends: 0.68 },
        { symbol: "META", shares: 10, avgCost: 665.50, price: 667.78, marketValue: 6677.75, costBasis: 6655.00, unrealizedGL: 22.75, unrealizedPct: 0.0034, realizedGL: 13.34, dividends: 0 },
        { symbol: "TSLA", shares: 15, avgCost: 424.92, price: 427.05, marketValue: 6405.76, costBasis: 6373.74, unrealizedGL: 32.02, unrealizedPct: 0.005, realizedGL: 324.21, dividends: 0 },
        { symbol: "INTC", shares: 100, avgCost: 53.51, price: 48.11, marketValue: 4810.85, costBasis: 5351.23, unrealizedGL: -540.38, unrealizedPct: -0.101, realizedGL: 0, dividends: 0 },
        { symbol: "MU", shares: 10, avgCost: 415.00, price: 414.40, marketValue: 4144.00, costBasis: 4150.00, unrealizedGL: -6.00, unrealizedPct: -0.0014, realizedGL: 0, dividends: 0 },
        { symbol: "HOOD", shares: 50, avgCost: 95.88, price: 77.69, marketValue: 3884.50, costBasis: 4794.00, unrealizedGL: -909.50, unrealizedPct: -0.1897, realizedGL: 0, dividends: 0 },
        { symbol: "AAPL", shares: 10, avgCost: 269.00, price: 275.55, marketValue: 2755.50, costBasis: 2690.00, unrealizedGL: 65.50, unrealizedPct: 0.0244, realizedGL: 0, dividends: 0 },
        { symbol: "BE (Indiv)", shares: 15, avgCost: 115.07, price: 154.25, marketValue: 2313.75, costBasis: 1726.00, unrealizedGL: 587.75, unrealizedPct: 0.3405, realizedGL: 0, dividends: 0 },
        { symbol: "RDW", shares: 100, avgCost: 13.67, price: 8.93, marketValue: 893.00, costBasis: 1366.74, unrealizedGL: -473.74, unrealizedPct: -0.3466, realizedGL: 0, dividends: 0 },
        { symbol: "TSLA (Indiv)", shares: 2, avgCost: 448.55, price: 427.05, marketValue: 854.10, costBasis: 897.10, unrealizedGL: -43.00, unrealizedPct: -0.0479, realizedGL: 0, dividends: 0 },
        { symbol: "VGT", shares: 1.002, avgCost: 719.58, price: 748.17, marketValue: 749.67, costBasis: 721.02, unrealizedGL: 28.65, unrealizedPct: 0.0397, realizedGL: 0, dividends: 1.62 },
        { symbol: "CRSP", shares: 2, avgCost: 54.24, price: 48.50, marketValue: 97.00, costBasis: 108.48, unrealizedGL: -11.48, unrealizedPct: -0.1058, realizedGL: 0, dividends: 0 },
      ],
      "Vanguard 401K": [
        { symbol: "Target 2035", shares: 197.836, avgCost: 27.79, price: 28.35, marketValue: 5608.65, costBasis: 5498.85, unrealizedGL: 109.80, unrealizedPct: 0.02, realizedGL: 0, dividends: 0 },
        { symbol: "Target 2040", shares: 36.207, avgCost: 50.72, price: 51.87, marketValue: 1878.06, costBasis: 1836.28, unrealizedGL: 41.78, unrealizedPct: 0.0228, realizedGL: 0, dividends: 0 },
      ],
      "Vanguard Brokerage": [
        { symbol: "TSLA", shares: 13, avgCost: 421.28, price: 427.05, marketValue: 5551.66, costBasis: 5476.64, unrealizedGL: 75.02, unrealizedPct: 0.0137, realizedGL: 324.21, dividends: 0 },
        { symbol: "GOOGL", shares: 15.017, avgCost: 201.36, price: 311.78, marketValue: 4682.00, costBasis: 3023.85, unrealizedGL: 1658.15, unrealizedPct: 0.5484, realizedGL: 0, dividends: 4.83 },
        { symbol: "HOOD", shares: 50, avgCost: 95.88, price: 77.69, marketValue: 3884.50, costBasis: 4794.00, unrealizedGL: -909.50, unrealizedPct: -0.1897, realizedGL: 0, dividends: 0 },
        { symbol: "NVDA", shares: 20.002, avgCost: 178.26, price: 190.40, marketValue: 3808.38, costBasis: 3565.48, unrealizedGL: 242.90, unrealizedPct: 0.0681, realizedGL: 774.15, dividends: 0.40 },
        { symbol: "VGT", shares: 1.002, avgCost: 719.58, price: 748.17, marketValue: 749.67, costBasis: 721.02, unrealizedGL: 28.65, unrealizedPct: 0.0397, realizedGL: 0, dividends: 1.62 },
      ],
      "Schwab PCRA Trust": [
        { symbol: "GOOGL", shares: 47, avgCost: 329.68, price: 311.78, marketValue: 14653.66, costBasis: 15495.15, unrealizedGL: -841.49, unrealizedPct: -0.0543, realizedGL: -904.03, dividends: 10.92 },
        { symbol: "META", shares: 10, avgCost: 665.50, price: 667.78, marketValue: 6677.75, costBasis: 6655.00, unrealizedGL: 22.75, unrealizedPct: 0.0034, realizedGL: 0, dividends: 0 },
        { symbol: "AAPL", shares: 10, avgCost: 269.00, price: 275.55, marketValue: 2755.50, costBasis: 2690.00, unrealizedGL: 65.50, unrealizedPct: 0.0244, realizedGL: 0, dividends: 0 },
        { symbol: "GOOG", shares: 6, avgCost: 288.79, price: 312.39, marketValue: 1874.34, costBasis: 1732.74, unrealizedGL: 141.60, unrealizedPct: 0.0817, realizedGL: 0, dividends: 1.26 },
      ],
      "Schwab PCRA Trust 2": [
        { symbol: "MU", shares: 10, avgCost: 415.00, price: 414.40, marketValue: 4144.00, costBasis: 4150.00, unrealizedGL: -6.00, unrealizedPct: -0.0014, realizedGL: 0, dividends: 0 },
        { symbol: "GOOGL", shares: 10, avgCost: 332.40, price: 311.78, marketValue: 3117.80, costBasis: 3324.00, unrealizedGL: -206.20, unrealizedPct: -0.0620, realizedGL: 0, dividends: 0 },
      ],
      "Schwab Individual": [
        { symbol: "PLTR", shares: 107, avgCost: 99.40, price: 134.89, marketValue: 14433.05, costBasis: 10635.45, unrealizedGL: 3797.60, unrealizedPct: 0.3571, realizedGL: 759.64, dividends: 0 },
        { symbol: "NVDA", shares: 28.002, avgCost: 176.26, price: 190.40, marketValue: 5331.49, costBasis: 4935.57, unrealizedGL: 395.92, unrealizedPct: 0.0802, realizedGL: 0, dividends: 0.28 },
        { symbol: "GOOGL", shares: 11, avgCost: 325.57, price: 311.78, marketValue: 3429.58, costBasis: 3581.28, unrealizedGL: -151.70, unrealizedPct: -0.0424, realizedGL: 0, dividends: 1.05 },
        { symbol: "BE", shares: 15, avgCost: 115.07, price: 154.25, marketValue: 2313.75, costBasis: 1726.00, unrealizedGL: 587.75, unrealizedPct: 0.3405, realizedGL: 0, dividends: 0 },
        { symbol: "TSLA", shares: 2, avgCost: 448.55, price: 427.05, marketValue: 854.10, costBasis: 897.10, unrealizedGL: -43.00, unrealizedPct: -0.0479, realizedGL: 0, dividends: 0 },
        { symbol: "CRSP", shares: 2, avgCost: 54.24, price: 48.50, marketValue: 97.00, costBasis: 108.48, unrealizedGL: -11.48, unrealizedPct: -0.1058, realizedGL: 0, dividends: 0 },
      ],
      "Schwab Rollover IRA": [
        { symbol: "GOOG", shares: 100, avgCost: 241.63, price: 312.39, marketValue: 31239.00, costBasis: 24162.50, unrealizedGL: 7076.50, unrealizedPct: 0.2929, realizedGL: 0, dividends: 21.00 },
        { symbol: "GOOGL", shares: 100, avgCost: 334.91, price: 311.78, marketValue: 31178.00, costBasis: 33490.82, unrealizedGL: -2312.82, unrealizedPct: -0.069, realizedGL: 2488.48, dividends: 0 },
        { symbol: "BE", shares: 200, avgCost: 160.36, price: 154.25, marketValue: 30850.00, costBasis: 32071.00, unrealizedGL: -1221.00, unrealizedPct: -0.0381, realizedGL: 4048.92, dividends: 0 },
        { symbol: "INTC", shares: 100, avgCost: 53.51, price: 48.11, marketValue: 4810.85, costBasis: 5351.23, unrealizedGL: -540.38, unrealizedPct: -0.101, realizedGL: 0, dividends: 0 },
        { symbol: "RDW", shares: 100, avgCost: 13.67, price: 8.93, marketValue: 893.00, costBasis: 1366.74, unrealizedGL: -473.74, unrealizedPct: -0.3466, realizedGL: 0, dividends: 0 },
      ],
    };

    const OPTIONS_ACTIVITY = [
      { option: "PLTR 01/30/2026 $185 C", status: "Expired", premium: 449.34, closeCost: 0, netPL: 449.34, account: "Schwab Individual" },
      { option: "PLTR 02/27/2026 $175 C", status: "OPEN", premium: 266.34, closeCost: 0, netPL: 266.34, account: "Schwab Individual" },
      { option: "MU 12/19/2025 $220 C", status: "Buy to Close", premium: 1530.34, closeCost: 3310.66, netPL: -1780.32, account: "Schwab Rollover IRA" },
      { option: "JNJ 11/21/2025 $197.50 C", status: "Buy to Close", premium: 180.34, closeCost: 78.66, netPL: 101.68, account: "Schwab Rollover IRA" },
      { option: "MU 11/28/2025 $245 C", status: "Buy to Close", premium: 1124.34, closeCost: 1245.66, netPL: -121.32, account: "Schwab Rollover IRA" },
      { option: "GOOG 11/21/2025 $255 C", status: "Buy to Close", premium: 1159.34, closeCost: 3710.66, netPL: -2551.32, account: "Schwab Rollover IRA" },
      { option: "PLTR 11/21/2025 $195 C", status: "Buy to Close", premium: 999.34, closeCost: 74.66, netPL: 924.68, account: "Schwab Rollover IRA" },
      { option: "PANW 11/28/2025 $222.50 C", status: "Expired", premium: 694.34, closeCost: 0, netPL: 694.34, account: "Schwab Rollover IRA" },
      { option: "PANW 01/09/2026 $220 C", status: "Buy to Close", premium: 100.34, closeCost: 75.66, netPL: 24.68, account: "Schwab Rollover IRA" },
      { option: "GOOG 12/26/2025 $325 C", status: "Buy to Close", premium: 999.34, closeCost: 690.66, netPL: 308.68, account: "Schwab Rollover IRA" },
      { option: "PLTR 12/19/2025 $185 C", status: "Assigned", premium: 230.34, closeCost: 0, netPL: 230.34, account: "Schwab Rollover IRA" },
      { option: "MU 12/26/2025 $235 C", status: "Assigned", premium: 1469.34, closeCost: 0, netPL: 1469.34, account: "Schwab Rollover IRA" },
      { option: "GOOG 01/23/2026 $320 C", status: "Buy to Close", premium: 719.34, closeCost: 1060.66, netPL: -341.32, account: "Schwab Rollover IRA" },
      { option: "GOOG 01/30/2026 $340 C", status: "Expired", premium: 314.34, closeCost: 0, netPL: 314.34, account: "Schwab Rollover IRA" },
      { option: "BE 01/30/2026 $150 C", status: "Assigned", premium: 394.34, closeCost: 0, netPL: 394.34, account: "Schwab Rollover IRA" },
      { option: "GOOGL 01/30/2026 $337.50 C", status: "Assigned", premium: 339.34, closeCost: 0, netPL: 339.34, account: "Schwab Rollover IRA" },
      { option: "BE 02/06/2026 $172.50 C", status: "Expired", premium: 1084.34, closeCost: 0, netPL: 1084.34, account: "Schwab Rollover IRA" },
      { option: "BE 02/06/2026 $170 C", status: "Expired", premium: 1207.34, closeCost: 0, netPL: 1207.34, account: "Schwab Rollover IRA" },
      { option: "GOOG 02/06/2026 $345 C", status: "Expired", premium: 737.34, closeCost: 0, netPL: 737.34, account: "Schwab Rollover IRA" },
      { option: "INTC 02/13/2026 $54 C", status: "OPEN", premium: 22.34, closeCost: 0, netPL: 22.34, account: "Schwab Rollover IRA" },
      { option: "BE 02/13/2026 $170 C", status: "OPEN", premium: 295.34, closeCost: 0, netPL: 295.34, account: "Schwab Rollover IRA" },
    ];

    const TRANSACTIONS = [
      { date: "2026-02-09", account: "Schwab Rollover IRA", category: "OPTIONS", action: "Sell to Open", symbol: "BE", amount: 295.34 },
      { date: "2026-02-06", account: "Vanguard 401K", category: "CONTRIBUTION", action: "Contribution", symbol: "Target 2035", amount: 765.86 },
      { date: "2026-02-06", account: "Vanguard 401K", category: "CONTRIBUTION", action: "Contribution", symbol: "Target 2040", amount: 255.29 },
      { date: "2026-02-06", account: "Schwab Individual", category: "BUY", action: "Buy", symbol: "PLTR", amount: -946.68 },
      { date: "2026-02-04", account: "Schwab Individual", category: "CASH_MGMT", action: "Transfer", symbol: "Cash", amount: 750.00 },
      { date: "2026-02-04", account: "Schwab Rollover IRA", category: "BUY", action: "Buy", symbol: "GOOGL", amount: -33490.82 },
      { date: "2026-02-03", account: "Vanguard Brokerage", category: "SELL", action: "Sell", symbol: "RIVN", amount: 28.01 },
      { date: "2026-02-03", account: "Schwab PCRA Trust", category: "BUY", action: "Buy", symbol: "GOOGL", amount: -1700.85 },
      { date: "2026-02-03", account: "Schwab Rollover IRA", category: "OPTIONS", action: "Sell to Open", symbol: "BE $172.50 C", amount: 1084.34 },
      { date: "2026-02-03", account: "Schwab Rollover IRA", category: "OPTIONS", action: "Sell to Open", symbol: "BE $170 C", amount: 1207.34 },
      { date: "2026-02-03", account: "Schwab Rollover IRA", category: "BUY", action: "Buy", symbol: "BE", amount: -16411.00 },
      { date: "2026-02-03", account: "Schwab Rollover IRA", category: "SELL", action: "Sell", symbol: "MU", amount: 41074.48 },
      { date: "2026-02-02", account: "Vanguard Brokerage", category: "BUY", action: "Buy", symbol: "HOOD", amount: -4794.00 },
      { date: "2026-02-02", account: "Vanguard Brokerage", category: "BUY", action: "Buy", symbol: "TSLA", amount: -5476.64 },
      { date: "2026-01-31", account: "Schwab Rollover IRA", category: "BUY", action: "Buy", symbol: "GOOGL", amount: -33908.12 },
      { date: "2026-01-31", account: "Schwab Rollover IRA", category: "SELL", action: "Sell", symbol: "MU", amount: 42074.98 },
      { date: "2026-01-30", account: "Schwab Rollover IRA", category: "BUY", action: "Buy", symbol: "BE", amount: -14845.00 },
      { date: "2026-01-27", account: "Schwab Rollover IRA", category: "OPTIONS", action: "Sell to Open", symbol: "GOOG $340 C", amount: 314.34 },
      { date: "2026-01-24", account: "Schwab Individual", category: "BUY", action: "Buy", symbol: "PLTR", amount: -4038.75 },
      { date: "2026-01-21", account: "Schwab Rollover IRA", category: "BUY", action: "Buy", symbol: "INTC", amount: -5351.23 },
      { date: "2025-12-30", account: "Schwab Rollover IRA", category: "BUY", action: "Buy", symbol: "RDW", amount: -1366.74 },
      { date: "2025-12-19", account: "Schwab Individual", category: "BUY", action: "Buy", symbol: "NVDA", amount: -2424.98 },
      { date: "2025-11-25", account: "Schwab Individual", category: "BUY", action: "Buy", symbol: "AVGO", amount: -5135.74 },
      { date: "2025-11-04", account: "Schwab Individual", category: "BUY", action: "Buy", symbol: "PLTR", amount: -5649.00 },
      { date: "2025-10-15", account: "Schwab PCRA Trust", category: "BUY", action: "Buy", symbol: "META", amount: -6655.00 },
      { date: "2025-10-01", account: "Vanguard Brokerage", category: "BUY", action: "Buy", symbol: "GOOGL", amount: -3023.85 },
      { date: "2025-09-15", account: "Schwab Rollover IRA", category: "BUY", action: "Buy", symbol: "GOOG", amount: -24162.50 },
    ];

    const MONTHS = ["All", "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    const YEARS = ["All", "2025", "2026"];
    const CATEGORIES = ["All", "BUY", "SELL", "OPTIONS", "CONTRIBUTION", "DIVIDEND", "CASH_MGMT"];
    const PIE_COLORS = ["#6366f1", "#22d3ee", "#a78bfa", "#f472b6", "#34d399", "#fbbf24", "#fb923c", "#f87171", "#818cf8", "#2dd4bf", "#e879f9", "#facc15", "#4ade80", "#f97316", "#c084fc", "#38bdf8"];

    // ─── Helpers ─────────────────────────────────────────────────────────────────

    const fmt = (n, decimals = 2) => {
      if (n == null || isNaN(n)) return "$0.00";
      const abs = Math.abs(n);
      const s = abs >= 1000
        ? "$" + abs.toLocaleString("en-US", { minimumFractionDigits: decimals, maximumFractionDigits: decimals })
        : "$" + abs.toFixed(decimals);
      return n < 0 ? "-" + s : s;
    };
    const fmtPct = (n) => (n * 100).toFixed(2) + "%";

    // ─── Components ──────────────────────────────────────────────────────────────

    function StatCard({ label, value, sub, positive, icon }) {
      const Icon = icon;
      return (
        <div style={{
          background: "linear-gradient(135deg, #111 0%, #0a0a0a 100%)",
          borderRadius: 16, padding: "20px 24px",
          border: "1px solid rgba(99,102,241,0.2)",
          flex: 1, minWidth: 180,
          position: "relative", overflow: "hidden",
        }}>
          <div style={{ position: "absolute", top: 16, right: 16, opacity: 0.15 }}>
            {Icon && <Icon size={40} />}
          </div>
          <div style={{ fontSize: 12, color: "#94a3b8", textTransform: "uppercase", letterSpacing: 1, marginBottom: 6 }}>{label}</div>
          <div style={{ fontSize: 26, fontWeight: 700, color: "#f1f5f9" }}>{value}</div>
          {sub && (
            <div style={{ fontSize: 13, marginTop: 4, color: positive === true ? "#34d399" : positive === false ? "#f87171" : "#94a3b8", display: "flex", alignItems: "center", gap: 4 }}>
              {positive === true && <ArrowUpRight size={14} />}
              {positive === false && <ArrowDownRight size={14} />}
              {sub}
            </div>
          )}
        </div>
      );
    }

    function Dropdown({ label, value, onChange, options }) {
      return (
        <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
          <span style={{ fontSize: 12, color: "#64748b", textTransform: "uppercase", letterSpacing: 0.5 }}>{label}</span>
          <div style={{ position: "relative" }}>
            <select
              value={value}
              onChange={(e) => onChange(e.target.value)}
              style={{
                background: "#1e293b", color: "#e2e8f0", border: "1px solid #334155",
                borderRadius: 8, padding: "8px 32px 8px 12px", fontSize: 13,
                appearance: "none", cursor: "pointer", outline: "none", minWidth: 140,
              }}
            >
              {options.map((o) => <option key={o} value={o}>{o}</option>)}
            </select>
            <ChevronDown size={14} style={{ position: "absolute", right: 10, top: "50%", transform: "translateY(-50%)", pointerEvents: "none", color: "#64748b" }} />
          </div>
        </div>
      );
    }

    function SortableTable({ columns, data, defaultSort, defaultDir }) {
      const [sortCol, setSortCol] = useState(defaultSort || columns[0].key);
      const [sortDir, setSortDir] = useState(defaultDir || "desc");

      const sorted = useMemo(() => {
        return [...data].sort((a, b) => {
          const va = a[sortCol], vb = b[sortCol];
          if (typeof va === "number" && typeof vb === "number") return sortDir === "asc" ? va - vb : vb - va;
          return sortDir === "asc" ? String(va).localeCompare(String(vb)) : String(vb).localeCompare(String(va));
        });
      }, [data, sortCol, sortDir]);

      const toggle = (key) => {
        if (sortCol === key) setSortDir(d => d === "asc" ? "desc" : "asc");
        else { setSortCol(key); setSortDir("desc"); }
      };

      return (
        <div style={{ overflowX: "auto", WebkitOverflowScrolling: "touch" }}>
          <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 13 }}>
            <thead>
              <tr>
                {columns.map((c) => (
                  <th key={c.key} onClick={() => toggle(c.key)}
                    style={{
                      textAlign: c.align || "left", padding: "10px 12px",
                      color: sortCol === c.key ? "#818cf8" : "#64748b",
                      cursor: "pointer", borderBottom: "1px solid #1a1a1a",
                      fontSize: 11, textTransform: "uppercase", letterSpacing: 0.5,
                      whiteSpace: "nowrap", userSelect: "none",
                    }}>
                    {c.label} {sortCol === c.key ? (sortDir === "asc" ? "\u25B2" : "\u25BC") : ""}
                  </th>
                ))}
              </tr>
            </thead>
            <tbody>
              {sorted.map((row, i) => (
                <tr key={i} style={{ borderBottom: "1px solid #111" }}>
                  {columns.map((c) => (
                    <td key={c.key} style={{
                      padding: "10px 12px", textAlign: c.align || "left",
                      color: c.color ? c.color(row[c.key], row) : "#cbd5e1",
                      fontWeight: c.bold ? 600 : 400, whiteSpace: "nowrap",
                      background: i % 2 === 0 ? "transparent" : "rgba(15,23,42,0.3)",
                    }}>
                      {c.render ? c.render(row[c.key], row) : row[c.key]}
                    </td>
                  ))}
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      );
    }

    // ─── Main Dashboard ──────────────────────────────────────────────────────────

    function PortfolioDashboard() {
      const [selectedAccount, setSelectedAccount] = useState("All Accounts");
      const [selectedYear, setSelectedYear] = useState("All");
      const [selectedMonth, setSelectedMonth] = useState("All");
      const [selectedCategory, setSelectedCategory] = useState("All");
      const [activeTab, setActiveTab] = useState("holdings");
      const [priceStatus, setPriceStatus] = useState("idle"); // idle | loading | done | error
      const [livePrices, setLivePrices] = useState({});
      const [uploadedTx, setUploadedTx] = useState(() => loadUploadedTransactions());
      const [uploadMsg, setUploadMsg] = useState("");
      const [hideAmounts, setHideAmounts] = useState(() => {
        try { return localStorage.getItem("portfolio_hide_amounts") === "true"; } catch { return false; }
      });
      const fileInputRef = useRef(null);

      // Persist hide toggle
      useEffect(() => { try { localStorage.setItem("portfolio_hide_amounts", hideAmounts); } catch {} }, [hideAmounts]);

      // Mask helper: replaces dollar amounts with dots
      const mask = (val) => hideAmounts ? "••••••" : val;

      // ─── Finnhub: fetch live prices on mount ────────────────────────────────────
      useEffect(() => {
        const allSymbols = (HOLDINGS_BY_ACCOUNT["All Accounts"] || []).map(h => h.symbol);
        if (allSymbols.length === 0) return;
        setPriceStatus("loading");
        fetchAllPrices(allSymbols).then(prices => {
          if (Object.keys(prices).length > 0) {
            setLivePrices(prices);
            setPriceStatus("done");
          } else {
            setPriceStatus("error");
          }
        }).catch(() => setPriceStatus("error"));
      }, []);

      // ─── Apply live prices to holdings ──────────────────────────────────────────
      const updatedHoldingsByAccount = useMemo(() => {
        if (Object.keys(livePrices).length === 0) return HOLDINGS_BY_ACCOUNT;
        const result = {};
        for (const [acct, holdingsList] of Object.entries(HOLDINGS_BY_ACCOUNT)) {
          result[acct] = holdingsList.map(h => {
            const cleanSym = h.symbol.replace(/\s*\(.*?\)\s*$/, "");
            const newPrice = livePrices[cleanSym];
            if (newPrice && newPrice !== h.price) {
              const marketValue = +(h.shares * newPrice).toFixed(2);
              const unrealizedGL = +(marketValue - h.costBasis).toFixed(2);
              const unrealizedPct = h.costBasis !== 0 ? +(unrealizedGL / h.costBasis).toFixed(4) : 0;
              return { ...h, price: newPrice, marketValue, unrealizedGL, unrealizedPct };
            }
            return h;
          });
        }
        return result;
      }, [livePrices]);

      // ─── Recalculate account totals from updated holdings ───────────────────────
      const updatedAccounts = useMemo(() => {
        if (Object.keys(livePrices).length === 0) return ACCOUNTS;
        const result = { ...ACCOUNTS };
        for (const [acct, holdingsList] of Object.entries(updatedHoldingsByAccount)) {
          if (acct === "All Accounts") continue;
          const orig = ACCOUNTS[acct];
          if (!orig) continue;
          const totalValue = holdingsList.reduce((s, h) => s + h.marketValue, 0);
          const unrealizedGL = holdingsList.reduce((s, h) => s + h.unrealizedGL, 0);
          const costBasis = holdingsList.reduce((s, h) => s + h.costBasis, 0);
          const unrealizedPct = costBasis !== 0 ? unrealizedGL / costBasis : 0;
          result[acct] = { ...orig, totalValue: +totalValue.toFixed(2), unrealizedGL: +unrealizedGL.toFixed(2), unrealizedPct: +unrealizedPct.toFixed(4) };
        }
        // Recalculate "All Accounts"
        const allAcct = { ...ACCOUNTS["All Accounts"] };
        let tv = 0, ugl = 0, cb = 0;
        for (const [acct, data] of Object.entries(result)) {
          if (acct === "All Accounts") continue;
          tv += data.totalValue; ugl += data.unrealizedGL; cb += data.costBasis || ACCOUNTS[acct].costBasis;
        }
        allAcct.totalValue = +tv.toFixed(2);
        allAcct.unrealizedGL = +ugl.toFixed(2);
        allAcct.unrealizedPct = cb !== 0 ? +(ugl / cb).toFixed(4) : 0;
        result["All Accounts"] = allAcct;
        return result;
      }, [livePrices, updatedHoldingsByAccount]);

      // ─── CSV Upload handler ─────────────────────────────────────────────────────
      const handleFileUpload = useCallback((e) => {
        const files = Array.from(e.target.files);
        if (!files.length) return;
        setUploadMsg("Processing...");
        let allNew = [];
        let processed = 0;

        files.forEach(file => {
          const reader = new FileReader();
          reader.onload = (ev) => {
            const text = ev.target.result;
            const txs = detectAndParseCSV(text, file.name);
            allNew = allNew.concat(txs);
            processed++;
            if (processed === files.length) {
              // Deduplicate: merge with existing uploaded transactions
              const existing = loadUploadedTransactions();
              const combined = [...existing];
              const existingKeys = new Set(existing.map(t => `${t.date}|${t.account}|${t.action}|${t.symbol}|${t.amount}`));
              let added = 0;
              allNew.forEach(t => {
                const key = `${t.date}|${t.account}|${t.action}|${t.symbol}|${t.amount}`;
                if (!existingKeys.has(key)) { combined.push(t); existingKeys.add(key); added++; }
              });
              saveUploadedTransactions(combined);
              setUploadedTx(combined);
              setUploadMsg(`Imported ${added} new transactions from ${files.length} file(s).`);
              setTimeout(() => setUploadMsg(""), 5000);
            }
          };
          reader.readAsText(file);
        });
        // Reset input so same file can be re-uploaded
        e.target.value = "";
      }, []);

      const accountData = updatedAccounts[selectedAccount];
      const holdings = updatedHoldingsByAccount[selectedAccount] || [];

      // Merge hardcoded + uploaded transactions
      const allTransactions = useMemo(() => {
        const hardcodedKeys = new Set(TRANSACTIONS.map(t => `${t.date}|${t.account}|${t.action}|${t.symbol}|${t.amount}`));
        const merged = [...TRANSACTIONS];
        uploadedTx.forEach(t => {
          const key = `${t.date}|${t.account}|${t.action}|${t.symbol}|${t.amount}`;
          if (!hardcodedKeys.has(key)) merged.push(t);
        });
        return merged.sort((a, b) => b.date.localeCompare(a.date));
      }, [uploadedTx]);

      const filteredTx = useMemo(() => {
        return allTransactions.filter((t) => {
          if (selectedAccount !== "All Accounts" && t.account !== selectedAccount) return false;
          if (selectedYear !== "All" && !t.date.startsWith(selectedYear)) return false;
          if (selectedMonth !== "All") {
            const m = parseInt(t.date.split("-")[1]);
            if (m !== MONTHS.indexOf(selectedMonth)) return false;
          }
          if (selectedCategory !== "All" && t.category !== selectedCategory) return false;
          return true;
        });
      }, [allTransactions, selectedAccount, selectedYear, selectedMonth, selectedCategory]);

      const filteredOptions = useMemo(() => {
        return OPTIONS_ACTIVITY.filter((o) => {
          if (selectedAccount !== "All Accounts" && o.account !== selectedAccount) return false;
          return true;
        });
      }, [selectedAccount]);

      const pieData = useMemo(() => {
        return holdings.map((h) => ({ name: h.symbol, value: h.marketValue })).sort((a, b) => b.value - a.value);
      }, [holdings]);

      const accountBarData = useMemo(() => {
        return Object.entries(updatedAccounts).filter(([k]) => k !== "All Accounts").map(([name, d]) => ({
          name: name.replace("Schwab ", "S. ").replace("Vanguard ", "V. "),
          fullName: name, value: d.totalValue, unrealized: d.unrealizedGL, realized: d.totalRealizedGL,
        }));
      }, [updatedAccounts]);

      const optionsByMonth = useMemo(() => {
        const map = {};
        OPTIONS_ACTIVITY.forEach((o) => {
          const parts = o.option.split(" ");
          const dateStr = parts[1];
          const [mm, dd, yyyy] = dateStr.split("/");
          const key = `${yyyy}-${mm}`;
          if (!map[key]) map[key] = { month: key, profit: 0, loss: 0 };
          if (o.netPL >= 0) map[key].profit += o.netPL;
          else map[key].loss += o.netPL;
        });
        return Object.values(map).sort((a, b) => a.month.localeCompare(b.month));
      }, []);

      const incomeData = [
        { name: "Realized G/L", value: accountData.totalRealizedGL },
        { name: "Options Premium", value: accountData.netOptionsPremium },
        { name: "Dividends", value: accountData.totalDividends },
      ];
      const totalIncome = accountData.totalRealizedGL + accountData.netOptionsPremium + accountData.totalDividends;

      const holdingsColumns = hideAmounts ? [
        { key: "symbol", label: "Symbol", bold: true, color: () => "#e2e8f0" },
        { key: "marketValue", label: "Allocation", align: "right", render: (v, row) => ((row.marketValue / accountData.totalValue) * 100).toFixed(1) + "%", color: () => "#818cf8" },
        { key: "price", label: "Price", align: "right", render: (v) => fmt(v) },
        { key: "unrealizedPct", label: "Unreal %", align: "right", render: (v) => fmtPct(v), color: (v) => v >= 0 ? "#34d399" : "#f87171" },
        { key: "realizedGL", label: "Realized %", align: "right", render: (v, row) => row.costBasis !== 0 ? fmtPct(row.realizedGL / row.costBasis) : "0.00%", color: (v) => v > 0 ? "#34d399" : v < 0 ? "#f87171" : "#64748b" },
      ] : [
        { key: "symbol", label: "Symbol", bold: true, color: () => "#e2e8f0" },
        { key: "shares", label: "Shares", align: "right", render: (v) => v.toFixed(2) },
        { key: "avgCost", label: "Avg Cost", align: "right", render: (v) => fmt(v) },
        { key: "price", label: "Price", align: "right", render: (v) => fmt(v) },
        { key: "marketValue", label: "Mkt Value", align: "right", render: (v) => fmt(v) },
        { key: "unrealizedGL", label: "Unrealized", align: "right", render: (v) => fmt(v), color: (v) => v >= 0 ? "#34d399" : "#f87171" },
        { key: "unrealizedPct", label: "Unreal %", align: "right", render: (v) => fmtPct(v), color: (v) => v >= 0 ? "#34d399" : "#f87171" },
        { key: "realizedGL", label: "Realized", align: "right", render: (v) => fmt(v), color: (v) => v > 0 ? "#34d399" : v < 0 ? "#f87171" : "#64748b" },
      ];

      const txColumns = [
        { key: "date", label: "Date", color: () => "#e2e8f0" },
        { key: "account", label: "Account" },
        { key: "action", label: "Action", color: (v) => v === "Buy" ? "#818cf8" : v === "Sell" ? "#fbbf24" : v.includes("Open") ? "#a78bfa" : "#cbd5e1" },
        { key: "symbol", label: "Symbol", bold: true, color: () => "#e2e8f0" },
        { key: "amount", label: hideAmounts ? "% of Portfolio" : "Amount", align: "right",
          render: (v) => hideAmounts ? (accountData.totalValue !== 0 ? fmtPct(Math.abs(v) / accountData.totalValue) : "0.00%") : fmt(v),
          color: (v) => v >= 0 ? "#34d399" : "#f87171" },
      ];

      const optionsColumns = [
        { key: "option", label: "Contract", bold: true, color: () => "#e2e8f0" },
        {
          key: "status", label: "Status",
          render: (v) => (
            <span style={{
              padding: "3px 10px", borderRadius: 20, fontSize: 11, fontWeight: 600,
              background: v === "OPEN" ? "rgba(99,102,241,0.2)" : v === "Expired" ? "rgba(100,116,139,0.2)" : v === "Assigned" ? "rgba(251,191,36,0.2)" : "rgba(244,114,182,0.2)",
              color: v === "OPEN" ? "#818cf8" : v === "Expired" ? "#94a3b8" : v === "Assigned" ? "#fbbf24" : "#f472b6",
            }}>{v}</span>
          ),
        },
        { key: "premium", label: hideAmounts ? "% of Portfolio" : "Premium", align: "right",
          render: (v) => hideAmounts ? (accountData.totalValue !== 0 ? fmtPct(v / accountData.totalValue) : "0.00%") : fmt(v),
          color: () => "#34d399" },
        ...(hideAmounts ? [] : [{ key: "closeCost", label: "Close Cost", align: "right", render: (v) => v > 0 ? fmt(v) : "\u2014", color: (v) => v > 0 ? "#f87171" : "#64748b" }]),
        { key: "netPL", label: hideAmounts ? "Return %" : "Net P/L", align: "right",
          render: (v, row) => hideAmounts ? (row.premium !== 0 ? fmtPct(row.netPL / row.premium) : "0.00%") : fmt(v),
          color: (v) => v >= 0 ? "#34d399" : "#f87171" },
        { key: "account", label: "Account" },
      ];

      const tabs = [
        { id: "holdings", label: "Holdings" },
        { id: "transactions", label: "Transactions" },
        { id: "options", label: "Options" },
      ];

      const customTooltip = ({ active, payload }) => {
        if (!active || !payload?.length) return null;
        const d = payload[0].payload;
        return (
          <div style={{ background: "#1e293b", border: "1px solid #334155", borderRadius: 8, padding: "10px 14px", fontSize: 12 }}>
            <div style={{ color: "#e2e8f0", fontWeight: 600 }}>{d.name}</div>
            <div style={{ color: "#818cf8" }}>{mask(fmt(d.value))}</div>
            <div style={{ color: "#64748b" }}>{((d.value / accountData.totalValue) * 100).toFixed(1)}% of portfolio</div>
          </div>
        );
      };

      return (
        <div className="main-wrap" style={{
          background: "#000000",
          minHeight: "100vh", color: "#cbd5e1",
          fontFamily: "'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif",
          padding: "24px 32px",
        }}>
          {/* Header */}
          <div className="header-row" style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 28 }}>
            <div>
              <h1 style={{ margin: 0, fontSize: 28, fontWeight: 700, color: "#f1f5f9", display: "flex", alignItems: "center", gap: 10 }}>
                <Activity size={28} color="#818cf8" /> Portfolio Tracker
              </h1>
              <div style={{ fontSize: 13, color: "#64748b", marginTop: 4, display: "flex", alignItems: "center", gap: 8 }}>
                {priceStatus === "loading" && <><span style={{ display: "inline-block", width: 8, height: 8, borderRadius: "50%", background: "#fbbf24", animation: "pulse 1s infinite" }} /> Fetching live prices...</>}
                {priceStatus === "done" && <><span style={{ display: "inline-block", width: 8, height: 8, borderRadius: "50%", background: "#34d399" }} /> Prices updated live</>}
                {priceStatus === "error" && <><span style={{ display: "inline-block", width: 8, height: 8, borderRadius: "50%", background: "#f87171" }} /> Price update failed - showing cached</>}
                {priceStatus === "idle" && <>Data sourced from Schwab & Vanguard</>}
              </div>
            </div>
            <div style={{ display: "flex", alignItems: "center", gap: 12, flexWrap: "wrap" }}>
              {/* Hide Amounts Toggle */}
              <div onClick={() => setHideAmounts(h => !h)} style={{
                display: "flex", alignItems: "center", gap: 8, cursor: "pointer", userSelect: "none",
                background: "rgba(255,255,255,0.05)", borderRadius: 10, padding: "8px 14px",
                border: "1px solid rgba(255,255,255,0.1)",
              }}>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke={hideAmounts ? "#f87171" : "#64748b"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                  {hideAmounts ? (
                    <><path d="M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94"/><path d="M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19"/><line x1="1" y1="1" x2="23" y2="23"/></>
                  ) : (
                    <><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></>
                  )}
                </svg>
                <span style={{ fontSize: 12, color: hideAmounts ? "#f87171" : "#94a3b8", fontWeight: 500 }}>
                  {hideAmounts ? "Hidden" : "Visible"}
                </span>
              </div>
              <button onClick={() => fileInputRef.current?.click()} style={{
                background: "linear-gradient(135deg, #6366f1, #818cf8)", color: "#fff",
                border: "none", borderRadius: 10, padding: "10px 18px", fontSize: 13,
                fontWeight: 600, cursor: "pointer", fontFamily: "inherit",
                display: "flex", alignItems: "center", gap: 6,
              }}>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                Upload CSV
              </button>
              <input ref={fileInputRef} type="file" accept=".csv" multiple onChange={handleFileUpload} style={{ display: "none" }} />
              <Dropdown label="Account" value={selectedAccount} onChange={setSelectedAccount} options={Object.keys(updatedAccounts)} />
            </div>
          </div>

          {/* Upload Message */}
          {uploadMsg && (
            <div style={{
              background: "rgba(99,102,241,0.15)", border: "1px solid rgba(99,102,241,0.3)",
              borderRadius: 10, padding: "10px 16px", marginBottom: 16,
              fontSize: 13, color: "#818cf8", display: "flex", alignItems: "center", gap: 8,
            }}>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
              {uploadMsg}
            </div>
          )}

          {/* Stat Cards */}
          <div className="stat-cards" style={{ display: "flex", gap: 16, marginBottom: 24, flexWrap: "wrap" }}>
            <StatCard label="Total Value" value={mask(fmt(accountData.totalValue))} sub={hideAmounts ? `${holdings.length} positions` : null} icon={DollarSign} />
            <StatCard label="Unrealized G/L" value={hideAmounts ? fmtPct(accountData.unrealizedPct) : fmt(accountData.unrealizedGL)} sub={hideAmounts ? "of cost basis" : fmtPct(accountData.unrealizedPct)} positive={accountData.unrealizedGL >= 0} icon={TrendingUp} />
            <StatCard label="Realized G/L" value={hideAmounts ? (accountData.costBasis !== 0 ? fmtPct(accountData.totalRealizedGL / accountData.costBasis) : "0.00%") : fmt(accountData.totalRealizedGL)} sub={hideAmounts ? "of cost basis" : `Short-term: ${fmt(accountData.realizedSTGL)}`} positive={accountData.totalRealizedGL >= 0} icon={BarChart3} />
            <StatCard label="Total Income" value={hideAmounts ? (accountData.totalValue !== 0 ? fmtPct(totalIncome / accountData.totalValue) : "0.00%") : fmt(totalIncome)} sub={hideAmounts ? "of portfolio value" : `Options: ${fmt(accountData.netOptionsPremium)} \u00B7 Div: ${fmt(accountData.totalDividends)}`} positive={totalIncome >= 0} icon={Activity} />
          </div>

          {/* Charts - 60% of viewport */}
          <div className="charts-grid" style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 16, marginBottom: 24, minHeight: "60vh" }}>
            {/* Asset Allocation - Large */}
            <div style={{ background: "linear-gradient(135deg, #111 0%, #0a0a0a 100%)", borderRadius: 16, padding: 24, border: "1px solid rgba(99,102,241,0.15)", display: "flex", flexDirection: "column" }}>
              <h3 style={{ margin: "0 0 12px", fontSize: 16, color: "#94a3b8", fontWeight: 600 }}>Asset Allocation</h3>
              <div className="pie-inner" style={{ display: "flex", alignItems: "center", flex: 1 }}>
                <ResponsiveContainer width="55%" height={340}>
                  <PieChart>
                    <Pie data={pieData} cx="50%" cy="50%" innerRadius={80} outerRadius={130} dataKey="value" strokeWidth={2} stroke="#000">
                      {pieData.map((_, i) => <Cell key={i} fill={PIE_COLORS[i % PIE_COLORS.length]} />)}
                    </Pie>
                    <Tooltip content={customTooltip} />
                  </PieChart>
                </ResponsiveContainer>
                <div style={{ flex: 1, fontSize: 12, lineHeight: 2.2 }}>
                  {pieData.map((d, i) => (
                    <div key={d.name} style={{ display: "flex", alignItems: "center", gap: 8 }}>
                      <div style={{ width: 10, height: 10, borderRadius: 3, background: PIE_COLORS[i % PIE_COLORS.length], flexShrink: 0 }} />
                      <span style={{ color: "#94a3b8" }}>{d.name}</span>
                      <span style={{ marginLeft: "auto", color: "#e2e8f0", fontWeight: 500 }}>{((d.value / accountData.totalValue) * 100).toFixed(1)}%</span>
                    </div>
                  ))}
                </div>
              </div>
            </div>

            {/* Account Values - Large */}
            <div style={{ background: "linear-gradient(135deg, #111 0%, #0a0a0a 100%)", borderRadius: 16, padding: 24, border: "1px solid rgba(99,102,241,0.15)", display: "flex", flexDirection: "column" }}>
              <h3 style={{ margin: "0 0 16px", fontSize: 16, color: "#94a3b8", fontWeight: 600 }}>Account Values</h3>
              <ResponsiveContainer width="100%" height={340}>
                <BarChart data={accountBarData} margin={{ top: 10, right: 10, bottom: 10, left: 10 }}>
                  <CartesianGrid strokeDasharray="3 3" stroke="#1a1a1a" />
                  <XAxis dataKey="name" tick={{ fill: "#64748b", fontSize: 11 }} axisLine={false} tickLine={false} />
                  <YAxis tick={{ fill: "#64748b", fontSize: 11 }} axisLine={false} tickLine={false} tickFormatter={(v) => hideAmounts ? "••" : `$${(v / 1000).toFixed(0)}k`} />
                  <Tooltip contentStyle={{ background: "#1e293b", border: "1px solid #334155", borderRadius: 8, fontSize: 12 }} formatter={(v) => [hideAmounts ? fmtPct(v / accountData.totalValue) + " of total" : fmt(v), ""]} labelFormatter={(l, payload) => payload?.[0]?.payload?.fullName || l} />
                  <Bar dataKey="value" radius={[6, 6, 0, 0]}>
                    {accountBarData.map((_, i) => <Cell key={i} fill={PIE_COLORS[i]} />)}
                  </Bar>
                </BarChart>
              </ResponsiveContainer>
            </div>

            {/* Income Summary - Large */}
            <div style={{ background: "linear-gradient(135deg, #111 0%, #0a0a0a 100%)", borderRadius: 16, padding: 24, border: "1px solid rgba(99,102,241,0.15)", display: "flex", flexDirection: "column" }}>
              <h3 style={{ margin: "0 0 8px", fontSize: 16, color: "#94a3b8", fontWeight: 600 }}>Income Summary</h3>
              <div style={{ fontSize: 32, fontWeight: 700, color: totalIncome >= 0 ? "#34d399" : "#f87171", marginBottom: 20 }}>
                {hideAmounts ? (accountData.totalValue !== 0 ? fmtPct(totalIncome / accountData.totalValue) + " of portfolio" : "0.00%") : fmt(totalIncome)}
              </div>
              {incomeData.map((d, i) => {
                const pct = totalIncome > 0 ? (d.value / totalIncome) * 100 : 0;
                const colors = ["#6366f1", "#a78bfa", "#22d3ee"];
                return (
                  <div key={d.name} style={{ marginBottom: 16 }}>
                    <div style={{ display: "flex", justifyContent: "space-between", fontSize: 13, marginBottom: 6 }}>
                      <span style={{ color: "#94a3b8" }}>{d.name}</span>
                      <span style={{ color: "#e2e8f0", fontWeight: 500 }}>{hideAmounts ? pct.toFixed(1) + "% of income" : fmt(d.value)}</span>
                    </div>
                    <div style={{ height: 10, background: "#111", borderRadius: 5, overflow: "hidden" }}>
                      <div style={{ height: "100%", width: `${Math.max(pct, 0)}%`, background: colors[i], borderRadius: 5, transition: "width 0.5s ease" }} />
                    </div>
                  </div>
                );
              })}
              {selectedAccount === "All Accounts" && (
                <div style={{ marginTop: 20, flex: 1, display: "flex", flexDirection: "column" }}>
                  <div style={{ fontSize: 12, color: "#64748b", marginBottom: 12, textTransform: "uppercase", letterSpacing: 0.5 }}>Options P/L by Month</div>
                  <ResponsiveContainer width="100%" height={140}>
                    <BarChart data={optionsByMonth} margin={{ top: 0, right: 0, bottom: 0, left: 0 }}>
                      <XAxis dataKey="month" tick={{ fill: "#475569", fontSize: 10 }} axisLine={false} tickLine={false} tickFormatter={(v) => v.split("-")[1] + "/" + v.split("-")[0].slice(2)} />
                      <Tooltip contentStyle={{ background: "#1e293b", border: "1px solid #334155", borderRadius: 8, fontSize: 11 }} formatter={(v) => [mask(fmt(v)), ""]} />
                      <Bar dataKey="profit" fill="#34d399" radius={[3, 3, 0, 0]} stackId="a" />
                      <Bar dataKey="loss" fill="#f87171" radius={[0, 0, 3, 3]} stackId="a" />
                    </BarChart>
                  </ResponsiveContainer>
                </div>
              )}
            </div>

            {/* Holdings Performance Bar Chart - New */}
            <div style={{ background: "linear-gradient(135deg, #111 0%, #0a0a0a 100%)", borderRadius: 16, padding: 24, border: "1px solid rgba(99,102,241,0.15)", display: "flex", flexDirection: "column" }}>
              <h3 style={{ margin: "0 0 16px", fontSize: 16, color: "#94a3b8", fontWeight: 600 }}>Holdings Performance (%)</h3>
              <ResponsiveContainer width="100%" height={340}>
                <BarChart data={holdings.map(h => ({ name: h.symbol, pct: +(h.unrealizedPct * 100).toFixed(2) })).sort((a, b) => b.pct - a.pct)} layout="vertical" margin={{ top: 5, right: 30, bottom: 5, left: 60 }}>
                  <CartesianGrid strokeDasharray="3 3" stroke="#1a1a1a" horizontal={false} />
                  <XAxis type="number" tick={{ fill: "#64748b", fontSize: 11 }} axisLine={false} tickLine={false} tickFormatter={(v) => `${v}%`} />
                  <YAxis type="category" dataKey="name" tick={{ fill: "#e2e8f0", fontSize: 11 }} axisLine={false} tickLine={false} width={50} />
                  <Tooltip contentStyle={{ background: "#1e293b", border: "1px solid #334155", borderRadius: 8, fontSize: 12 }} formatter={(v) => [`${v}%`, "Return"]} />
                  <Bar dataKey="pct" radius={[0, 4, 4, 0]}>
                    {holdings.map(h => h.unrealizedPct * 100).sort((a, b) => b - a).map((v, i) => (
                      <Cell key={i} fill={v >= 0 ? "#34d399" : "#f87171"} />
                    ))}
                  </Bar>
                </BarChart>
              </ResponsiveContainer>
            </div>
          </div>

          {/* Tab Navigation */}
          <div className="tab-nav" style={{ display: "flex", alignItems: "center", gap: 24, marginBottom: 16, borderBottom: "1px solid #1a1a1a", paddingBottom: 0, flexWrap: "wrap" }}>
            {tabs.map((t) => (
              <button key={t.id} onClick={() => setActiveTab(t.id)}
                style={{
                  background: "none", border: "none", cursor: "pointer",
                  color: activeTab === t.id ? "#818cf8" : "#64748b",
                  fontSize: 14, fontWeight: 600, paddingBottom: 12,
                  borderBottom: activeTab === t.id ? "2px solid #818cf8" : "2px solid transparent",
                  transition: "all 0.2s", fontFamily: "inherit",
                }}>
                {t.label}
                {t.id === "options" && (
                  <span style={{ marginLeft: 6, padding: "1px 7px", borderRadius: 10, background: "rgba(99,102,241,0.15)", color: "#818cf8", fontSize: 11 }}>
                    {filteredOptions.length}
                  </span>
                )}
              </button>
            ))}
            {activeTab === "transactions" && (
              <div className="filter-row" style={{ display: "flex", gap: 12, marginLeft: "auto" }}>
                <Dropdown label="Year" value={selectedYear} onChange={setSelectedYear} options={YEARS} />
                <Dropdown label="Month" value={selectedMonth} onChange={setSelectedMonth} options={MONTHS} />
                <Dropdown label="Type" value={selectedCategory} onChange={setSelectedCategory} options={CATEGORIES} />
              </div>
            )}
          </div>

          {/* Table Content */}
          <div style={{
            background: "linear-gradient(135deg, #111 0%, #0a0a0a 100%)",
            borderRadius: 16, padding: 20, border: "1px solid rgba(99,102,241,0.15)", minHeight: 300,
          }}>
            {activeTab === "holdings" && (
              <>
                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 12, flexWrap: "wrap", gap: 8 }}>
                  <div style={{ fontSize: 13, color: "#64748b" }}>{holdings.length} positions · Click headers to sort</div>
                  <div style={{ fontSize: 13, color: "#94a3b8" }}>
                    {hideAmounts ? (
                      <>Unrealized: <span style={{ color: accountData.unrealizedGL >= 0 ? "#34d399" : "#f87171", fontWeight: 600 }}>{fmtPct(accountData.unrealizedPct)}</span></>
                    ) : (
                      <>Total: <span style={{ color: "#e2e8f0", fontWeight: 600 }}>{fmt(accountData.totalValue)}</span>
                      {" \u00B7 "}Cost: <span style={{ color: "#e2e8f0", fontWeight: 600 }}>{fmt(accountData.costBasis)}</span></>
                    )}
                  </div>
                </div>
                <SortableTable columns={holdingsColumns} data={holdings} defaultSort="marketValue" />
              </>
            )}
            {activeTab === "transactions" && (
              <>
                <div style={{ fontSize: 13, color: "#64748b", marginBottom: 12 }}>{filteredTx.length} transactions</div>
                {filteredTx.length > 0 ? (
                  <SortableTable columns={txColumns} data={filteredTx} defaultSort="date" />
                ) : (
                  <div style={{ textAlign: "center", padding: 40, color: "#475569" }}>No transactions match the selected filters.</div>
                )}
              </>
            )}
            {activeTab === "options" && (
              <>
                <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 12 }}>
                  <div style={{ fontSize: 13, color: "#64748b" }}>{filteredOptions.length} contracts</div>
                  <div style={{ fontSize: 13 }}>
                    {(() => {
                      const netPL = filteredOptions.reduce((s, o) => s + o.netPL, 0);
                      const totalPrem = filteredOptions.reduce((s, o) => s + o.premium, 0);
                      return hideAmounts ? (
                        <>Net Return: <span style={{ color: netPL >= 0 ? "#34d399" : "#f87171", fontWeight: 600 }}>{totalPrem !== 0 ? fmtPct(netPL / totalPrem) : "0.00%"}</span></>
                      ) : (
                        <>Net P/L: <span style={{ color: netPL >= 0 ? "#34d399" : "#f87171", fontWeight: 600 }}>{fmt(netPL)}</span></>
                      );
                    })()}
                  </div>
                </div>
                <SortableTable columns={optionsColumns} data={filteredOptions} defaultSort="netPL" />
              </>
            )}
          </div>

          {/* Footer */}
          <div style={{ textAlign: "center", marginTop: 24, fontSize: 11, color: "#334155" }}>
            Data sourced from Schwab & Vanguard · Prices via Finnhub · For informational purposes only
            {uploadedTx.length > 0 && <> · {uploadedTx.length} uploaded transactions</>}
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<PortfolioDashboard />);
  </script>
</body>
</html>
